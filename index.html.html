<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Management Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Scrollbar for Dark Theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d; 
        }
        ::-webkit-scrollbar-thumb {
            background: #555; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777; 
        }
        body {
            background-color: #383838;
            color: #ffffff;
            font-family: sans-serif;
            overflow: hidden; 
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col relative overflow-hidden bg-[#383838]">

    <!-- App Container -->
    <div id="app" class="h-full w-full flex overflow-hidden">
        <!-- Content injected by JS -->
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden p-4">
        <!-- Modal injected by JS -->
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-max max-w-xs text-center">
        <!-- Toasts injected by JS -->
    </div>

    <!-- Global Hidden Input for Actual File Uploads -->
    <input type="file" id="global-file-upload" class="hidden" onchange="processFileUpload(event)">

<script>
    const now = Date.now();
    const dayMs = 24 * 60 * 60 * 1000;

    // --- STATE MANAGEMENT ---
    const state = {
        currentUser: null, 
        activeTab: 'admin', 
        currentProject: 'p1',
        searchQuery: '',
        sortBy: 'all', // all, retake, uploaded, approved, wip, paused, hold
        expandedAssignments: [], 
        expandedStages: [], // Tracks which completed stages are opened
        profileMenuOpen: false, 
        
        // Temporary states for modals & uploads
        tempProjectImg: null,
        tempProjectName: '',
        tempAssignmentImg: null,
        tempAssignmentInputUrl: null,
        tempAssignmentInputName: null,
        tempAssignmentName: '',
        tempAssignmentMandays: '',
        tempAssignmentLevels: '',
        pendingDeletion: null, 
        uploadingAssignmentId: null, 
        
        // Retake Modal States
        tempRetakeFileUrl: null,
        tempRetakeFileName: null,
        tempRetakeNote: '',

        // Team Modal States
        tempTeamUserName: '',
        tempTeamRole: 'client',
        selectedUserName: '', 
        
        // Mock Data
        users: [
            { id: 'u1', username: 'admin', password: '123', role: 'admin', name: 'admin', profilePic: null },
            { id: 'u2', logincode: 'gus123', role: 'freelancer', name: 'gus', profilePic: null, allowedProjects: ['p1'] },
            { id: 'u3', logincode: 'jhon123', role: 'client', name: 'jhon', profilePic: null, allowedProjects: ['p1', 'p2'] }
        ],
        projects: [
            { id: 'p1', name: 'Tangled', img: 'https://placehold.co/100x100/4c3d75/ffffff?text=Tangled', active: true },
            { id: 'p2', name: 'AVATAR', img: 'https://placehold.co/100x100/000000/00a8ff?text=AVATAR', active: false },
            { id: 'p3', name: 'DRAGONS', img: 'https://placehold.co/100x100/55cceb/ff0000?text=DRAGONS', active: false }
        ],
        assignments: [
            { id: 'a5', projectId: 'p1', name: 'Pascal', status: 'uploaded', img: 'https://placehold.co/100x100/3e8e41/ffffff?text=Pascal', inputData: { url: null, name: 'Pascal_References.zip' }, levels: ['Level 1'], currentLevelIndex: 0, completedLevels: [], versions: [{vName: 'v02', fileUrl: null, filename: 'Pascal_v02.png'}, {vName: 'v01', fileUrl: null, filename: 'Pascal_v01.png'}], mandays: 5, createdAt: now - (4 * dayMs) },
            { id: 'a1', projectId: 'p1', name: 'Rapunzel', status: 'wip', img: 'https://placehold.co/100x100/e6c9a8/000000?text=Rapunzel', inputData: { url: null, name: 'Rapunzel_Model.obj' }, levels: ['Blockout', 'Texturing'], currentLevelIndex: 0, completedLevels: [], versions: [{vName: 'v08', fileUrl: null, filename: 'Rapunzel_v08.png'}, {vName: 'v07', fileUrl: null, filename: 'Rapunzel_v07.png'}, {vName: 'v06', fileUrl: null, filename: 'Rapunzel_v06.png'}, {vName: 'v05', fileUrl: null, filename: 'Rapunzel_v05.png'}], mandays: 10, createdAt: now - (2 * dayMs) },
            { id: 'a2', projectId: 'p1', name: 'Flynn Rider', status: 'retake', img: 'https://placehold.co/100x100/1a495e/ffffff?text=Flynn', inputData: null, levels: ['Level 1'], currentLevelIndex: 0, completedLevels: [], versions: [{vName: 'v03', fileUrl: null, filename: 'Feedback_Flynn.jpg', isRetake: true, note: 'Make the smile wider, see attached reference.'}, {vName: 'v02', fileUrl: null, filename: 'Flynn_v02.png'}, {vName: 'v01', fileUrl: null, filename: 'Flynn_v01.png'}], mandays: 3, createdAt: now - (5 * dayMs) },
            { id: 'a3', projectId: 'p1', name: 'Mother Gothel', status: 'approved', img: 'https://placehold.co/100x100/3d2235/ffffff?text=Gothel', inputData: null, levels: ['Level 1'], currentLevelIndex: 0, completedLevels: [{levelName: 'Level 1', finalFileUrl: null, finalFilename: 'Gothel_v04.png', finalVName: 'v04', versions: [{vName: 'v04', fileUrl: null, filename: 'Gothel_v04.png'}, {vName: 'v03', fileUrl: null, filename: 'Gothel_v03.png'}]}], versions: [], mandays: 4, createdAt: now - (4 * dayMs) },
            { id: 'a4', projectId: 'p1', name: 'Maximus', status: 'paused', img: 'https://placehold.co/100x100/e0e0e0/000000?text=Maximus', inputData: null, levels: ['Level 1', 'Level 2', 'Level 3'], currentLevelIndex: 0, completedLevels: [], versions: [], mandays: 7, createdAt: now - (1 * dayMs) }
        ],
        generatedCode: ''
    };

    // --- GLOBAL CLICK LISTENER (For Profile Menu) ---
    document.addEventListener('click', () => {
        if (state.profileMenuOpen) {
            state.profileMenuOpen = false;
            if (state.currentUser) renderDashboard(); 
        }
    });

    // --- TOAST NOTIFICATIONS ---
    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = `px-6 py-3 rounded-md shadow-xl text-white text-sm font-medium transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.textContent = message;
        
        const container = document.getElementById('toast-container');
        container.appendChild(toast);
        
        // Fade out and remove
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300); 
        }, 3000);
    }

    // --- ICONS (SVG) ---
    const icons = {
        user: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="white" class="mx-auto drop-shadow-lg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>`,
        edit: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="bg-blue-500 rounded-full p-0.5"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>`,
        clip: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>`,
        arrowDown: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
        arrowUp: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>`,
        download: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
        check: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
        copy: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`,
        toggleOff: `<svg width="28" height="16" viewBox="0 0 36 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="20" rx="10" fill="#444" stroke="#666" stroke-width="1"/><circle cx="10" cy="10" r="6" fill="#888"/></svg>`,
        toggleOn: `<svg width="28" height="16" viewBox="0 0 36 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="20" rx="10" fill="#3b82f6"/><circle cx="26" cy="10" r="7" fill="#ffffff"/></svg>`,
        play: `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`,
        pause: `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`
    };

    // --- HELPER FUNCTIONS ---
    const getStatusColor = (status) => {
        switch(status) {
            case 'wip': return 'text-yellow-500';
            case 'paused': return 'text-blue-400';
            case 'retake': return 'text-red-500';
            case 'client_approved': return 'text-orange-500';
            case 'approved': return 'text-green-500';
            case 'hold': return 'text-gray-500';
            case 'uploaded': return 'text-orange-500';
            case 'published': return 'text-orange-500';
            default: return 'text-gray-400';
        }
    };

    const getStatusCircle = (status) => {
        const bgColors = {
            'wip': 'bg-yellow-500',
            'paused': 'bg-blue-400',
            'retake': 'bg-red-500',
            'client_approved': 'bg-orange-500',
            'approved': 'bg-green-500',
            'hold': 'bg-gray-500',
            'uploaded': 'bg-orange-500',
            'published': 'bg-orange-500'
        };
        return `<div class="w-3 h-3 rounded-full ${bgColors[status] || 'bg-gray-400'} mr-2 shrink-0"></div>`;
    };

    // --- RENDER FUNCTIONS ---

    function renderLogin() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="m-auto w-full max-w-md bg-[#2a2a2a] shadow-xl rounded-lg overflow-hidden border border-gray-700">
                <div class="flex">
                    <button onclick="setTab('admin')" class="flex-1 py-3 text-lg font-medium transition-colors ${state.activeTab === 'admin' ? 'bg-[#333] text-white border-b-2 border-blue-500' : 'bg-[#1a1a1a] text-gray-400 hover:text-white'}">Admin</button>
                    <button onclick="setTab('user')" class="flex-1 py-3 text-lg font-medium transition-colors ${state.activeTab === 'user' ? 'bg-[#333] text-white border-b-2 border-blue-500' : 'bg-[#1a1a1a] text-gray-400 hover:text-white'}">User</button>
                </div>
                <div class="p-8 bg-[#333]">
                    ${state.activeTab === 'admin' ? `
                        <div class="space-y-6">
                            <div class="flex items-center">
                                <label class="w-24 text-gray-300">Username</label>
                                <input type="text" id="username" value="admin" class="flex-1 px-3 py-2 bg-white text-black focus:outline-none rounded-sm">
                            </div>
                            <div class="flex items-center">
                                <label class="w-24 text-gray-300">Password</label>
                                <input type="password" id="password" value="123" class="flex-1 px-3 py-2 bg-white text-black focus:outline-none rounded-sm">
                            </div>
                            <div class="flex justify-end pt-4">
                                <button onclick="handleLogin('admin')" class="px-6 py-2 bg-white text-black font-medium hover:bg-gray-200 transition-colors rounded-sm shadow">Login</button>
                            </div>
                        </div>
                    ` : `
                        <div class="space-y-6">
                            <div class="flex items-center">
                                <label class="w-28 text-gray-300">Login Code</label>
                                <input type="text" id="logincode" placeholder="e.g. gus123" class="flex-1 px-3 py-2 bg-white text-black focus:outline-none rounded-sm">
                            </div>
                            <div class="flex justify-end pt-4">
                                <button onclick="handleLogin('user')" class="px-6 py-2 bg-white text-black font-medium hover:bg-gray-200 transition-colors rounded-sm shadow">Login</button>
                            </div>
                        </div>
                    `}
                </div>
            </div>
        `;
    }

    function renderDashboard() {
        const app = document.getElementById('app');
        
        // Calculate total non-admin team members
        const teamMemberCount = state.users.filter(u => u.role !== 'admin').length;
        
        // Filter projects based on user access (Admin sees all)
        let visibleProjects = state.projects;
        if (state.currentUser.role !== 'admin') {
            const allowed = state.currentUser.allowedProjects || [];
            visibleProjects = state.projects.filter(p => allowed.includes(p.id));
        }

        app.innerHTML = `
            <!-- Sidebar -->
            <div class="w-20 md:w-28 bg-[#383838] flex flex-col items-center py-6 border-r border-gray-600 shrink-0 relative z-20">
                
                <!-- Profile Picture Area -->
                <div class="relative mb-2 cursor-pointer" onclick="toggleProfileMenu(event)">
                    ${state.currentUser.profilePic 
                        ? `<img src="${state.currentUser.profilePic}" class="w-14 h-14 md:w-16 md:h-16 rounded-full object-cover border border-gray-500 shadow-lg mx-auto">` 
                        : icons.user
                    }
                    <div class="absolute bottom-0 right-0 bg-[#2d2d2d] rounded-full border border-gray-700">${icons.edit}</div>
                    
                    <!-- Profile Context Menu -->
                    ${state.profileMenuOpen ? `
                        <div class="absolute top-full mt-2 left-1/2 -translate-x-1/2 w-36 bg-[#444] rounded shadow-xl border border-gray-600 overflow-hidden z-50">
                            <button onclick="openEditNameModal(event)" class="w-full text-left px-4 py-2 text-sm hover:bg-[#555] text-white transition border-b border-gray-600">Edit Name</button>
                            <button onclick="triggerProfileUpload(event)" class="w-full text-left px-4 py-2 text-sm hover:bg-[#555] text-white transition">Upload Picture</button>
                            ${state.currentUser.profilePic ? `<button onclick="removeProfilePic(event)" class="w-full text-left px-4 py-2 text-sm hover:bg-[#555] text-red-400 transition border-t border-gray-600">Remove Picture</button>` : ''}
                        </div>
                    ` : ''}
                </div>
                <input type="file" id="profile-upload-input" class="hidden" accept="image/*" onchange="handleProfileUpload(event)">

                <div class="text-xs md:text-sm font-medium tracking-wide mb-8 mt-2 text-center w-full px-1 overflow-hidden text-ellipsis">${state.currentUser.name}</div>
                
                ${state.currentUser.role === 'admin' ? `
                <div class="w-full px-2">
                    <button onclick="openModal('team')" class="w-full flex items-center justify-between bg-[#444] hover:bg-[#555] rounded px-2 py-2 text-xs md:text-sm transition border border-gray-600">
                        <span class="truncate font-medium">Team: ${teamMemberCount}</span>
                    </button>
                </div>
                ` : ''}
            </div>

            <!-- Main Content Area -->
            <!-- The min-w-0 class is critically important to prevent flex children from blowing past the screen width on mobile -->
            <div class="flex-1 flex flex-col h-full bg-[#383838] relative overflow-hidden min-w-0">
                
                <!-- Logout Button (Top Right) -->
                <div class="absolute top-4 right-4 md:right-8 z-10">
                    <button onclick="logout()" class="text-sm md:text-base text-gray-200 hover:text-white bg-[#444] hover:bg-[#555] px-4 py-1.5 rounded border border-gray-600 shadow transition">
                        Logout
                    </button>
                </div>

                <!-- Top Row: Projects Bar -->
                <div class="pt-4 px-4 md:px-6 flex space-x-2 shrink-0 overflow-x-auto hide-scroll pb-2 pr-28 w-full">
                    ${visibleProjects.map(p => `
                        <div class="relative shrink-0">
                            <div onclick="setProject('${p.id}')" class="w-[60px] h-[60px] md:w-[72px] md:h-[72px] cursor-pointer border-2 transition-all shadow-md ${state.currentProject === p.id ? 'border-white opacity-100' : 'border-transparent opacity-60 hover:opacity-100'}">
                                <img src="${p.img}" alt="${p.name}" class="w-full h-full object-cover">
                            </div>
                            ${state.currentUser.role === 'admin' ? `
                                <button onclick="promptDeleteProject('${p.id}', event)" title="Delete Project" class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md z-10 transition">×</button>
                            ` : ''}
                        </div>
                    `).join('')}
                    
                    ${state.currentUser.role === 'admin' ? `
                        <button onclick="openModal('project')" class="w-[60px] h-[60px] md:w-[72px] md:h-[72px] shrink-0 bg-white text-black text-4xl font-bold flex items-center justify-center hover:bg-gray-200 transition shadow-md">
                            +
                        </button>
                    ` : ''}
                    
                    ${visibleProjects.length === 0 && state.currentUser.role !== 'admin' ? `
                        <div class="text-gray-400 mt-4 italic">No projects assigned. Please contact your administrator.</div>
                    ` : ''}
                </div>

                <!-- Search & Sort Strip -->
                <div class="w-full px-4 md:px-8 py-2 border-b border-gray-600 shrink-0 flex justify-end items-center gap-3 bg-[#383838] flex-wrap">
                    
                    <!-- Filter Dropdown -->
                    <div class="flex items-center">
                        <span class="mr-2 text-sm text-gray-200 tracking-wider">Filter</span>
                        <select onchange="handleSort(event)" class="bg-[#444] text-white text-sm px-2 py-1 border border-gray-500 focus:outline-none shadow-inner rounded-sm cursor-pointer hover:bg-[#555] transition">
                            <option value="all" ${state.sortBy === 'all' ? 'selected' : ''}>All</option>
                            <option value="retake" ${state.sortBy === 'retake' ? 'selected' : ''}>Retake</option>
                            <option value="uploaded" ${state.sortBy === 'uploaded' ? 'selected' : ''}>Published</option>
                            <option value="approved" ${state.sortBy === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="wip" ${state.sortBy === 'wip' ? 'selected' : ''}>WIP</option>
                            <option value="paused" ${state.sortBy === 'paused' ? 'selected' : ''}>Paused</option>
                            <option value="hold" ${state.sortBy === 'hold' ? 'selected' : ''}>Hold</option>
                        </select>
                    </div>

                    <!-- Search Input -->
                    <div class="flex items-center">
                        <span class="mr-3 text-sm text-gray-200 tracking-wider">Search</span>
                        <input type="text" value="${state.searchQuery}" onkeyup="handleSearch(event)" class="w-32 md:w-48 px-2 py-1 bg-white text-black focus:outline-none shadow-inner">
                    </div>

                </div>

                <!-- Large Dark Gray Container for Assignments -->
                <!-- min-h-0 and min-w-0 ensure the flexbox doesn't push bounds outward on mobile -->
                <div class="flex-1 m-2 md:m-4 p-2 md:p-4 bg-[#2e2e2e] rounded shadow-inner flex flex-col border border-gray-700 min-h-0 min-w-0 overflow-hidden">
                    
                    ${state.currentUser.role === 'admin' && state.currentProject ? `
                        <div class="mb-4 shrink-0">
                            <button onclick="openModal('assignment')" class="w-12 h-12 md:w-16 md:h-16 bg-white text-black text-3xl md:text-4xl font-bold flex items-center justify-center hover:bg-gray-200 transition border border-gray-400 shadow">
                                +
                            </button>
                        </div>
                    ` : ''}
                    
                    <!-- Assignments List -->
                    <!-- overflow-x-auto allows horizontal scrolling for assignment rows that exceed mobile width -->
                    <div class="flex-1 overflow-y-auto overflow-x-auto pr-2 space-y-1 md:space-y-[2px]" id="assignments-container">
                        ${renderAssignmentsList()}
                    </div>
                </div>

            </div>
        `;
    }

    function renderAssignmentsList() {
        if (!state.currentProject) {
            return `<div class="text-gray-500 text-center mt-10">No project selected. Select or create a new project above.</div>`;
        }

        let filteredAssignments = state.assignments.filter(a => a.projectId === state.currentProject);
        
        // Search Filter
        if (state.searchQuery) {
            filteredAssignments = filteredAssignments.filter(a => a.name.toLowerCase().includes(state.searchQuery.toLowerCase()));
        }

        // Status Filter
        if (state.sortBy !== 'all') {
            filteredAssignments = filteredAssignments.filter(a => {
                if (state.sortBy === 'approved') return a.status === 'approved' || a.status === 'client_approved';
                return a.status === state.sortBy;
            });
        }

        // Sort by Newest First (New to Old) for all views
        filteredAssignments.sort((a, b) => b.createdAt - a.createdAt);

        if (filteredAssignments.length === 0) {
             return `<div class="text-gray-500 text-center mt-10">No assignments found matching these criteria.</div>`;
        }

        return filteredAssignments.map(a => {
            const isExpanded = state.expandedAssignments.includes(a.id);
            const statusColor = getStatusColor(a.status);
            
            // Calculate Progress based on elapsed days vs mandays
            let progressHtml = '';
            if (a.mandays) {
                const elapsedDays = Math.max(0, (Date.now() - a.createdAt) / (1000 * 60 * 60 * 24));
                const percent = Math.min(100, (elapsedDays / a.mandays) * 100);
                const isOverdue = elapsedDays > a.mandays && a.status !== 'approved';
                let barColor = isOverdue ? 'bg-red-500' : 'bg-blue-500';
                if (a.status === 'approved') barColor = 'bg-green-500';
                
                progressHtml = `
                    <div class="flex flex-col w-full" title="${elapsedDays.toFixed(1)} days elapsed out of ${a.mandays} mandays">
                        <div class="flex justify-between text-[10px] text-gray-400 mb-1 leading-none">
                            <span>${elapsedDays.toFixed(1)}d</span>
                            <span>${a.mandays}d</span>
                        </div>
                        <div class="w-full bg-[#222] rounded-full h-2 overflow-hidden border border-gray-600">
                            <div class="${barColor} h-full transition-all" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }

            // Manage display text for specific statuses
            let displayStatus = a.status;
            if (a.status === 'uploaded' || a.status === 'client_approved') displayStatus = 'published';
            
            const hasInputData = a.inputData && a.inputData.name;
            
            // Setup Play/Pause Button Logic for Admin and Freelancer
            let playPauseBtn = '';
            if (state.currentUser.role === 'admin' || state.currentUser.role === 'freelancer') {
                if (a.status === 'paused' || a.status === 'retake') {
                     playPauseBtn = `<button onclick="updateStatus('${a.id}', 'wip')" class="text-blue-400 hover:text-blue-300 transition" title="Play / Start Work">${icons.play}</button>`;
                } else if (a.status === 'wip') {
                     playPauseBtn = `<button onclick="updateStatus('${a.id}', 'paused')" class="text-orange-400 hover:text-orange-300 transition" title="Pause">${icons.pause}</button>`;
                }
            }

            // Setup Approval / Action Buttons
            let actionHtml = '';
            if (state.currentUser.role === 'client') {
                 if (a.status === 'uploaded') {
                     actionHtml = `<button onclick="updateStatus('${a.id}', 'client_approved')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 font-medium transition rounded-sm shadow text-sm shrink-0">Approve</button>`;
                 } else if (a.status === 'client_approved') {
                     actionHtml = `<div class="bg-green-500 w-6 h-6 md:w-7 md:h-7 flex items-center justify-center rounded-sm shadow text-white shrink-0">${icons.check}</div>`;
                 }
            } else if (state.currentUser.role === 'admin') {
                 if (a.status === 'uploaded') {
                     actionHtml = `<button onclick="openRetakeModal('${a.id}')" class="text-red-500 font-bold text-base md:text-lg hover:text-red-400 transition shrink-0">RT</button>`;
                 } else if (a.status === 'client_approved') {
                     actionHtml = `
                        <div class="flex space-x-2 items-center">
                            <div class="bg-green-500 w-6 h-6 md:w-7 md:h-7 flex items-center justify-center rounded-sm shadow text-white shrink-0">${icons.check}</div>
                            <button onclick="updateStatus('${a.id}', 'approved')" class="bg-green-600 hover:bg-green-500 text-white px-2 md:px-3 py-1 font-medium transition rounded-sm shadow text-xs md:text-sm shrink-0">Approve</button>
                            <button onclick="openRetakeModal('${a.id}')" class="text-red-500 font-bold text-base md:text-lg hover:text-red-400 transition shrink-0">RT</button>
                        </div>
                     `;
                 } else if (a.status === 'approved') {
                     actionHtml = `<button onclick="openRetakeModal('${a.id}')" class="text-red-500 font-bold text-base md:text-lg hover:text-red-400 transition shrink-0">RT</button>`;
                 }
            }

            // Optional Level Badge next to title
            const levelBadge = (a.levels && a.levels.length > 1) 
                ? `<div class="text-[10px] ml-2 px-1.5 py-0.5 bg-blue-900/40 text-blue-300 border border-blue-700/50 rounded-sm whitespace-nowrap shrink-0">${a.status === 'approved' ? 'Finished' : a.levels[a.currentLevelIndex]}</div>`
                : '';

            return `
                <!-- min-w-max on mobile forces the box to stretch to content size if it exceeds screen, avoiding text wrapping layout breaks -->
                <div class="flex flex-col bg-[#3a3a3a] border border-gray-600 rounded-sm w-max min-w-full md:w-auto">
                    <!-- Main Row -->
                    <div class="flex items-center p-2">
                        
                        <!-- Image & Admin Controls Container -->
                        <div class="flex flex-col items-center shrink-0 w-20 md:w-24">
                            <div class="w-16 h-12 md:w-20 md:h-14 bg-black border border-gray-500 shadow-sm">
                                <img src="${a.img}" class="w-full h-full object-cover" alt="${a.name}">
                            </div>
                            ${state.currentUser.role === 'admin' ? `
                                <div class="flex items-center justify-center space-x-3 mt-2 w-full">
                                    <button onclick="updateStatus('${a.id}', '${a.status === 'hold' ? 'wip' : 'hold'}')" class="transition shrink-0 hover:opacity-80 scale-90" title="Toggle Hold Status">
                                        ${a.status === 'hold' ? icons.toggleOn : icons.toggleOff}
                                    </button>
                                    <button onclick="promptDeleteAssignment('${a.id}', event)" class="text-red-500 hover:text-red-400 transition shrink-0" title="Delete Assignment">
                                        ${icons.trash}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Title & Level Badge -->
                        <div class="w-28 md:w-48 pl-2 md:pl-4 flex items-center text-base md:text-lg tracking-wide shrink-0">
                            <span class="truncate max-w-[90px] md:max-w-[140px]">${a.name}</span>
                            ${levelBadge}
                        </div>
                        
                        <!-- Status -->
                        <div class="w-28 md:w-40 flex items-center cursor-pointer ml-2 md:ml-4 shrink-0" onclick="toggleVersions('${a.id}')">
                            ${getStatusCircle(displayStatus)}
                            <span class="${statusColor} w-16 md:w-24 text-sm md:text-lg truncate capitalize">${displayStatus}</span>
                            <span class="text-gray-400 ml-1 md:ml-2 shrink-0">
                                ${isExpanded ? icons.arrowUp : icons.arrowDown}
                            </span>
                        </div>
                        
                        <!-- Actions, Progress, & Play/Pause (Strictly Aligned Columns) -->
                        <div class="flex-1 flex items-center pl-2 md:pl-4">
                            <!-- Action Block -->
                            <div class="w-24 md:w-40 flex items-center justify-start shrink-0">
                                ${actionHtml}
                            </div>
                            
                            <!-- Progress Block -->
                            <div class="w-20 md:w-32 flex items-center justify-center shrink-0">
                                ${progressHtml}
                            </div>
                            
                            <!-- Play/Pause Block -->
                            <div class="w-8 md:w-12 flex items-center justify-center shrink-0 ml-2 md:ml-4">
                                ${playPauseBtn}
                            </div>
                        </div>
                        
                        <!-- Right Download/Upload & Clip -->
                        <div class="flex items-center justify-end space-x-3 pr-2 md:pr-4 min-w-[100px] md:min-w-[120px] shrink-0">
                            <!-- Input Data Clip -->
                            <span class="cursor-pointer transition shrink-0 ${hasInputData ? 'text-blue-400 hover:text-blue-300' : 'text-gray-600 hover:text-gray-500'}" 
                                  onclick="downloadInputData('${a.id}')" 
                                  title="${hasInputData ? 'Download Input Data' : 'No input data attached'}">
                                ${icons.clip}
                            </span>
                            
                            <!-- Download / Upload buttons -->
                            <div class="flex flex-col items-end justify-center text-xs md:text-sm text-gray-400 space-y-1">
                                ${a.status !== 'hold' ? `
                                    <button class="hover:text-white transition tracking-wide" onclick="handleDownload('${a.id}', 0)">Download</button>
                                    ${(a.status === 'approved' && (state.currentUser.role === 'client' || state.currentUser.role === 'freelancer')) ? '' : `
                                        <button class="hover:text-white transition tracking-wide" onclick="${state.currentUser.role === 'client' ? `openRetakeModal('${a.id}')` : `triggerFileUpload('${a.id}')`}">${state.currentUser.role === 'client' ? 'Retake' : 'Upload'}</button>
                                    `}
                                ` : `
                                    <span class="text-gray-600 italic px-2">On Hold</span>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Versions Area -->
                    ${isExpanded && (a.versions.length > 0 || (a.completedLevels && a.completedLevels.length > 0)) ? `
                        <div class="bg-[#383838] py-3 w-full border-t border-gray-700">
                            <div class="ml-[180px] md:ml-[370px] flex flex-col pr-4">
                                
                                <!-- Completed Levels / Milestones (Accordion Style) -->
                                ${a.completedLevels && a.completedLevels.length > 0 ? `
                                    <div class="mb-4">
                                        <div class="text-[10px] text-gray-400 mb-2 font-bold tracking-wider uppercase">Completed Stages</div>
                                        ${a.completedLevels.map((cl, i) => {
                                            const stageId = a.id + '_' + i;
                                            const isStageExpanded = state.expandedStages && state.expandedStages.includes(stageId);
                                            return `
                                                <div class="mb-2 bg-[#2d2d2d] rounded border border-gray-600/50 overflow-hidden shadow-sm">
                                                    <!-- Minimized Bar Header -->
                                                    <div class="flex items-center p-2 cursor-pointer hover:bg-[#333] transition" onclick="toggleStage('${a.id}', ${i})">
                                                        <div class="w-3 h-3 rounded-full bg-green-500 mr-3 shrink-0 shadow-sm"></div>
                                                        <span class="w-24 md:w-32 font-bold text-green-400 truncate text-sm" title="${cl.levelName}">${cl.levelName}</span>
                                                        <span class="flex-1 text-gray-400 truncate text-xs mr-4" title="${cl.finalFilename || ''}">${cl.finalFilename || 'No file'}</span>
                                                        
                                                        ${cl.finalFileUrl || cl.finalFilename ? `
                                                            <button class="text-white bg-green-600 hover:bg-green-500 px-3 py-1 rounded-sm text-xs transition mr-4 shadow-sm font-medium tracking-wide" title="Download Final File" onclick="handleDownloadCompleted('${a.id}', ${i}, event)">Download Final</button>
                                                        ` : ''}
                                                        
                                                        <span class="text-gray-400 shrink-0 w-4">
                                                            ${isStageExpanded ? icons.arrowUp : icons.arrowDown}
                                                        </span>
                                                    </div>
                                                    
                                                    <!-- Expanded History for this Stage -->
                                                    ${isStageExpanded && cl.versions && cl.versions.length > 0 ? `
                                                        <div class="border-t border-gray-600/50 bg-[#252525] p-2 flex flex-col">
                                                            ${cl.versions.map((v, vIdx) => `
                                                                <div class="flex flex-col py-1.5 border-b border-gray-700/50 last:border-0 pl-6">
                                                                    <div class="flex items-center space-x-3 text-sm min-w-[250px] max-w-sm">
                                                                        ${getStatusCircle(v.isRetake ? 'retake' : 'approved')} 
                                                                        <span class="w-8 font-medium ${v.isRetake ? 'text-red-400' : 'text-gray-400'}">${v.vName}</span>
                                                                        <span class="flex-1 ${v.isRetake ? 'text-red-300' : 'text-gray-500'} truncate text-xs mr-4" title="${v.filename || ''}">${v.filename || (v.isRetake ? 'No file attached' : '')}</span>
                                                                        ${v.fileUrl || v.filename ? `
                                                                            <button class="text-gray-400 hover:text-blue-400 transition ml-auto" title="Download ${v.filename || v.vName}" onclick="handleDownloadStageVersion('${a.id}', ${i}, ${vIdx}, event)">${icons.download}</button>
                                                                        ` : ''}
                                                                    </div>
                                                                    ${v.note ? `
                                                                        <div class="ml-[44px] mt-1 text-xs text-red-300 italic break-words w-64 md:w-80 border-l-2 border-red-500/50 pl-2 py-0.5">"${v.note}"</div>
                                                                    ` : ''}
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}

                                <!-- Current/Active Level Versions -->
                                ${a.versions && a.versions.length > 0 ? `
                                    <div class="text-[10px] text-gray-400 mb-2 font-bold tracking-wider uppercase">Active Stage (${a.levels && a.levels.length > 0 ? a.levels[a.currentLevelIndex] : 'Final'})</div>
                                    <div class="bg-[#2d2d2d] rounded border border-gray-600/50 p-2">
                                        ${a.versions.map((v, idx) => `
                                            <div class="flex flex-col py-1.5 border-b border-gray-700/50 last:border-0">
                                                <div class="flex items-center space-x-3 text-sm min-w-[250px] max-w-sm">
                                                    ${getStatusCircle(v.isRetake ? 'retake' : (idx === 0 ? displayStatus : 'approved'))} 
                                                    <span class="w-8 font-medium ${v.isRetake ? 'text-red-400' : 'text-gray-300'}">${v.vName}</span>
                                                    <span class="flex-1 ${v.isRetake ? 'text-red-300' : 'text-gray-500'} truncate text-xs mr-4" title="${v.filename || ''}">${v.filename || (v.isRetake ? 'No file attached' : '')}</span>
                                                    ${v.fileUrl || v.filename ? `
                                                        <button class="text-gray-400 hover:text-blue-400 transition ml-auto" title="Download ${v.filename || v.vName}" onclick="handleDownload('${a.id}', ${idx})">${icons.download}</button>
                                                    ` : ''}
                                                </div>
                                                ${v.note ? `
                                                    <div class="ml-[44px] mt-1 text-xs text-red-300 italic break-words w-64 md:w-80 border-l-2 border-red-500/50 pl-2 py-0.5">"${v.note}"</div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : (a.status === 'approved' ? `<div class="text-sm text-green-500 italic font-medium">All stages complete.</div>` : `<div class="text-sm text-gray-500 italic">No files uploaded for this stage yet.</div>`)}

                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    function renderModals() {
        const container = document.getElementById('modal-container');
        if (container.classList.contains('hidden')) return;

        const type = container.dataset.modalType;
        let content = '';

        if (type === 'project') {
            content = `
                <div class="bg-[#383838] p-6 rounded-lg w-[calc(100%-2rem)] md:w-96 shadow-2xl relative border border-gray-600 mx-auto max-w-sm">
                    <button onclick="closeModal()" class="absolute top-2 right-4 text-xl font-bold text-red-500 hover:text-red-400">×</button>
                    
                    <div onclick="document.getElementById('project-img-upload').click()" class="w-16 h-16 bg-white flex items-center justify-center text-black text-4xl font-bold mb-4 mx-auto cursor-pointer border border-gray-500 hover:bg-gray-200 transition overflow-hidden">
                        ${state.tempProjectImg ? `<img src="${state.tempProjectImg}" class="w-full h-full object-cover">` : '+'}
                    </div>
                    <input type="file" id="project-img-upload" class="hidden" accept="image/*" onchange="handleTempImgUpload(event, 'project')">
                    
                    <input type="text" id="new-project-name" value="${state.tempProjectName || ''}" oninput="state.tempProjectName = this.value" placeholder="Name of project" class="w-full px-3 py-2 bg-white text-black mb-4 focus:outline-none">
                    <div class="flex justify-center">
                        <button onclick="createProject()" class="text-white hover:underline text-lg tracking-wider">Create</button>
                    </div>
                </div>
            `;
        } else if (type === 'assignment') {
            content = `
                <div class="bg-[#383838] p-6 rounded-lg w-[calc(100%-2rem)] md:w-96 shadow-2xl relative border border-gray-600 mx-auto max-w-sm">
                    <button onclick="closeModal()" class="absolute top-2 right-4 text-xl font-bold text-red-500 hover:text-red-400">×</button>
                    
                    <div onclick="document.getElementById('assignment-img-upload').click()" class="w-16 h-16 bg-white flex items-center justify-center text-black text-4xl font-bold mb-4 mx-auto cursor-pointer border border-gray-500 hover:bg-gray-200 transition overflow-hidden">
                        ${state.tempAssignmentImg ? `<img src="${state.tempAssignmentImg}" class="w-full h-full object-cover">` : '+'}
                    </div>
                    <input type="file" id="assignment-img-upload" class="hidden" accept="image/*" onchange="handleTempImgUpload(event, 'assignment')">

                    <input type="text" id="new-assignment-name" value="${state.tempAssignmentName || ''}" oninput="state.tempAssignmentName = this.value" placeholder="Assignment Name" class="w-full px-3 py-2 bg-white text-black mb-4 focus:outline-none rounded-sm">
                    
                    <div class="mb-4">
                        <label class="block text-gray-300 text-sm mb-1 ml-1">Mandays (Estimated Time)</label>
                        <input type="number" id="new-assignment-mandays" value="${state.tempAssignmentMandays || ''}" oninput="state.tempAssignmentMandays = this.value" placeholder="e.g. 5" min="0.5" step="0.5" class="w-full px-3 py-2 bg-white text-black focus:outline-none rounded-sm">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-300 text-sm mb-1 ml-1">Levels / Stages</label>
                        <input type="text" id="new-assignment-levels" value="${state.tempAssignmentLevels || ''}" oninput="state.tempAssignmentLevels = this.value" placeholder="e.g. 3 OR Blockout, Texture, Final" class="w-full px-3 py-2 bg-white text-black focus:outline-none rounded-sm">
                    </div>

                    <!-- NEW INPUT DATA ATTACHMENT -->
                    <div class="flex justify-center mb-6">
                        <input type="file" id="assignment-input-data" class="hidden" onchange="handleInputDataUpload(event)">
                        <button onclick="document.getElementById('assignment-input-data').click()" class="flex items-center space-x-2 text-gray-300 hover:text-white bg-[#444] hover:bg-[#555] px-4 py-2 rounded-sm border border-gray-500 transition shadow-inner w-full justify-center">
                            <span class="${state.tempAssignmentInputName ? 'text-blue-400' : 'text-gray-400'}">${icons.clip}</span>
                            <span class="truncate max-w-[200px] text-sm">${state.tempAssignmentInputName || 'Attach Input Data'}</span>
                        </button>
                    </div>

                    <div class="flex justify-center">
                        <button onclick="createAssignment()" class="text-white hover:underline text-lg tracking-wider">Create</button>
                    </div>
                </div>
            `;
        } else if (type === 'retake') {
            content = `
                <div class="bg-[#383838] p-6 rounded-lg w-[calc(100%-2rem)] md:w-96 shadow-2xl relative border border-gray-600 mx-auto max-w-sm">
                    <h2 class="text-xl text-white font-medium mb-4">Retake Feedback</h2>
                    <textarea id="retake-note" oninput="state.tempRetakeNote = this.value" placeholder="Enter retake notes (optional)..." class="w-full px-3 py-2 bg-[#2d2d2d] text-white border border-gray-600 mb-4 h-24 focus:outline-none focus:border-red-500 transition shadow-inner resize-none">${state.tempRetakeNote || ''}</textarea>
                    
                    <div class="flex justify-center mb-6">
                        <input type="file" id="retake-file" class="hidden" onchange="handleRetakeFileUpload(event)">
                        <button onclick="document.getElementById('retake-file').click()" class="flex items-center space-x-2 text-gray-300 hover:text-white bg-[#444] hover:bg-[#555] px-4 py-2 rounded-sm border border-gray-500 transition shadow-inner w-full justify-center">
                            <span class="${state.tempRetakeFileName ? 'text-red-400' : 'text-gray-400'}">${icons.clip}</span>
                            <span class="truncate max-w-[200px] text-sm">${state.tempRetakeFileName || 'Attach Feedback File'}</span>
                        </button>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-sm transition shadow">Cancel</button>
                        <button onclick="submitRetake()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-sm transition shadow">Send Retake</button>
                    </div>
                </div>
            `;
        } else if (type === 'edit-name') {
            content = `
                <div class="bg-[#383838] p-6 rounded-lg w-[calc(100%-2rem)] md:w-96 shadow-2xl relative border border-gray-600 mx-auto max-w-sm">
                    <button onclick="closeModal()" class="absolute top-2 right-4 text-xl font-bold text-red-500 hover:text-red-400">×</button>
                    <h2 class="text-xl text-white font-medium mb-4">Edit Profile Name</h2>
                    <input type="text" id="edit-name-input" value="${state.currentUser.name}" class="w-full px-3 py-2 bg-white text-black mb-6 focus:outline-none rounded-sm">
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-sm transition shadow">Cancel</button>
                        <button onclick="saveProfileName()" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-sm transition shadow">Save</button>
                    </div>
                </div>
            `;
        } else if (type === 'team') {
            const teamMembers = state.users.filter(u => u.role !== 'admin');
            content = `
                <div class="bg-[#383838] p-4 md:p-6 rounded-lg w-[calc(100%-2rem)] max-w-3xl shadow-2xl relative border border-gray-600 flex flex-col md:flex-row h-[75vh] md:h-[500px] mx-auto max-h-[90vh]">
                    
                    <!-- Left Panel (New User Form) -->
                    <div class="flex-1 md:pr-6 border-b md:border-b-0 md:border-r border-gray-600 flex flex-col pb-4 md:pb-0 shrink-0">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <h2 class="text-lg md:text-xl font-medium tracking-wide">Create Access</h2>
                            <button onclick="closeModal()" class="md:hidden text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center font-bold hover:bg-gray-200 shadow">×</button>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="role" value="client" onchange="state.tempTeamRole = this.value" class="w-4 h-4" ${(!state.tempTeamRole || state.tempTeamRole === 'client') ? 'checked' : ''}>
                                <span class="text-base md:text-lg">Client</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="role" value="freelancer" onchange="state.tempTeamRole = this.value" class="w-4 h-4" ${state.tempTeamRole === 'freelancer' ? 'checked' : ''}>
                                <span class="text-base md:text-lg">Freelancer</span>
                            </label>
                        </div>
                        
                        <input type="text" id="team-name" value="${state.tempTeamUserName || ''}" oninput="state.tempTeamUserName = this.value" placeholder="Name" class="w-full px-2 py-1 bg-white text-black focus:outline-none mb-4 border border-gray-400 shadow-inner">
                        <button onclick="generateCode()" class="bg-green-700 hover:bg-green-600 text-white px-6 py-2 w-max mb-2 md:mb-4 rounded-sm shadow">Add</button>
                        
                        ${state.generatedCode ? `
                            <div class="mt-4 pt-4 border-t border-gray-600">
                                <div class="text-sm text-gray-300 mb-1">Code for: <span class="text-white font-bold">${state.selectedUserName}</span></div>
                                <input type="text" readonly value="${state.generatedCode}" class="w-full px-2 py-1 bg-gray-200 text-black focus:outline-none mb-2 font-mono text-sm border border-gray-400 shadow-inner">
                                <button onclick="copyGeneratedCode()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-1 w-max rounded-sm shadow">Copy Code</button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Right Panel (Actual Dynamic User List) -->
                    <div class="w-full md:w-1/2 pt-4 md:pt-0 md:pl-6 flex flex-col min-h-[200px] overflow-hidden">
                        <div class="flex justify-between items-center mb-4 hidden md:flex">
                            <h3 class="text-lg text-gray-300 font-medium tracking-wide">People List</h3>
                            <button onclick="closeModal()" class="text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center font-bold hover:bg-gray-200 shadow">×</button>
                        </div>
                        <h3 class="text-lg text-gray-300 font-medium tracking-wide mb-3 md:hidden">People List</h3>
                        
                        <!-- Scrollable list of users -->
                        <div class="flex-1 overflow-y-auto pr-1">
                            ${teamMembers.map(u => `
                                <div class="flex flex-col bg-[#444] rounded-sm border border-gray-600 shadow-sm mb-2">
                                    <div onclick="selectUserCode('${u.logincode}', '${u.name}')" class="flex justify-between items-center px-3 py-2 cursor-pointer hover:bg-[#555] transition">
                                        <div class="overflow-hidden pr-2 flex-1 pointer-events-none">
                                            <div class="text-base font-medium text-white truncate">${u.name}</div>
                                            <div class="text-xs text-gray-400 capitalize mt-1">${u.role}</div>
                                        </div>
                                        <button onclick="promptDeleteUser('${u.id}', event)" title="Remove User" class="text-red-400 hover:text-red-300 font-bold w-6 h-6 flex items-center justify-center hover:bg-[#666] rounded-full transition shrink-0 ml-2">
                                            ×
                                        </button>
                                    </div>
                                    <!-- Project Access Controls -->
                                    <div class="px-3 pb-3 pt-1 border-t border-gray-600 mt-1">
                                        <div class="text-xs text-gray-400 mb-1.5">Project Access:</div>
                                        <div class="flex flex-wrap gap-1.5">
                                            ${state.projects.map(p => {
                                                const hasAccess = u.allowedProjects && u.allowedProjects.includes(p.id);
                                                return `<button onclick="toggleAccess('${u.id}', '${p.id}', event)" 
                                                    class="text-[10px] px-2 py-1 rounded-sm border transition ${hasAccess ? 'bg-blue-600 border-blue-500 text-white' : 'bg-[#333] border-gray-500 text-gray-400 hover:text-gray-200'}" title="Toggle access for ${p.name}">
                                                    ${p.name}
                                                </button>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${teamMembers.length === 0 ? `<div class="text-gray-500 text-sm text-center mt-4">No people added</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        } else if (type === 'confirm-delete') {
            const isProject = state.pendingDeletion.type === 'project';
            const isAssignment = state.pendingDeletion.type === 'assignment';
            const isUser = state.pendingDeletion.type === 'user';
            
            let item, itemType, warningText;
            if (isProject) {
                item = state.projects.find(p => p.id === state.pendingDeletion.id);
                itemType = 'project';
                warningText = 'All associated assignments will also be deleted permanently.';
            } else if (isAssignment) {
                item = state.assignments.find(a => a.id === state.pendingDeletion.id);
                itemType = 'assignment';
                warningText = 'This action cannot be undone.';
            } else if (isUser) {
                item = state.users.find(u => u.id === state.pendingDeletion.id);
                itemType = 'team member';
                warningText = 'This will immediately revoke their access to the portal.';
            }

            content = `
                <div class="bg-[#383838] p-6 rounded-lg w-[calc(100%-2rem)] md:w-96 shadow-2xl relative border border-gray-600 mx-auto max-w-sm text-center">
                    <h2 class="text-xl text-white font-medium mb-4">Confirm Deletion</h2>
                    <p class="text-gray-300 mb-6">
                        Are you sure you want to remove the ${itemType} "<span class="text-white font-bold">${item.name}</span>"?<br>
                        <span class="text-red-400 text-sm mt-2 inline-block">${warningText}</span>
                    </p>
                    <div class="flex justify-center space-x-4 mt-2">
                        <button onclick="${isUser ? `document.getElementById('modal-container').dataset.modalType = 'team'; renderModals(); state.pendingDeletion = null;` : 'closeModal()'}" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-sm transition shadow">Cancel</button>
                        <button onclick="executeDelete()" class="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-sm transition shadow">${isUser ? 'Remove' : 'Delete'}</button>
                    </div>
                </div>
            `;
        }

        container.innerHTML = content;
    }

    // --- ACTIONS & LOGIC ---

    function handleSort(e) {
        state.sortBy = e.target.value;
        document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
    }

    function promptDeleteProject(id, e) {
        e.stopPropagation();
        state.pendingDeletion = { type: 'project', id: id };
        openModal('confirm-delete');
    }

    function promptDeleteAssignment(id, e) {
        e.stopPropagation();
        state.pendingDeletion = { type: 'assignment', id: id };
        openModal('confirm-delete');
    }

    function promptDeleteUser(id, e) {
        e.stopPropagation();
        state.pendingDeletion = { type: 'user', id: id };
        openModal('confirm-delete');
    }

    function executeDelete() {
        if (!state.pendingDeletion) return;
        
        const { type, id } = state.pendingDeletion;
        
        if (type === 'project') {
            const project = state.projects.find(p => p.id === id);
            state.projects = state.projects.filter(p => p.id !== id);
            state.assignments = state.assignments.filter(a => a.projectId !== id);
            
            // Cleanup allowed projects from users
            state.users.forEach(u => {
                if (u.allowedProjects) {
                    u.allowedProjects = u.allowedProjects.filter(pId => pId !== id);
                }
            });
            
            if (state.currentProject === id) {
                state.currentProject = state.projects.length > 0 ? state.projects[0].id : null;
            }
            showToast(`Project '${project.name}' deleted`);
        } 
        else if (type === 'assignment') {
            const assignment = state.assignments.find(a => a.id === id);
            state.assignments = state.assignments.filter(a => a.id !== id);
            showToast(`Assignment '${assignment.name}' deleted`);
        }
        else if (type === 'user') {
            const user = state.users.find(u => u.id === id);
            state.users = state.users.filter(u => u.id !== id);
            
            if (state.generatedCode === user.logincode) {
                state.generatedCode = '';
                state.selectedUserName = '';
            }
            
            showToast(`Removed ${user.name} from team`);
            state.pendingDeletion = null;
            document.getElementById('modal-container').dataset.modalType = 'team';
            renderModals();
            if(state.currentUser) renderDashboard();
            return; // Skip normal close to stay in team modal
        }
        
        state.pendingDeletion = null;
        closeModal();
        renderDashboard();
    }

    function selectUserCode(code, name) {
        state.generatedCode = code;
        state.selectedUserName = name;
        renderModals();
    }

    function toggleAccess(userId, projectId, e) {
        e.stopPropagation();
        const user = state.users.find(u => u.id === userId);
        if (!user.allowedProjects) user.allowedProjects = [];
        
        if (user.allowedProjects.includes(projectId)) {
            user.allowedProjects = user.allowedProjects.filter(id => id !== projectId);
        } else {
            user.allowedProjects.push(projectId);
        }
        renderModals();
    }

    // --- INPUT DATA ATTACHMENT LOGIC ---
    function handleInputDataUpload(e) {
        const file = e.target.files[0];
        if (file) {
            state.tempAssignmentInputUrl = URL.createObjectURL(file);
            state.tempAssignmentInputName = file.name;
            renderModals();
        }
    }

    function downloadInputData(assignmentId) {
        const assignment = state.assignments.find(a => a.id === assignmentId);
        if (assignment && assignment.inputData && assignment.inputData.name) {
            if (assignment.inputData.url) {
                // Real file attached
                const a = document.createElement('a');
                a.href = assignment.inputData.url;
                a.download = assignment.inputData.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast(`Downloading input data: ${assignment.inputData.name}`);
            } else {
                // Mock data fallback
                showToast(`Downloading simulated input data: ${assignment.inputData.name}`);
            }
        } else {
            showToast("No input data attached to this assignment.", true);
        }
    }

    function handleTempImgUpload(e, type) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                if (type === 'project') state.tempProjectImg = event.target.result;
                else if (type === 'assignment') state.tempAssignmentImg = event.target.result;
                renderModals();
            };
            reader.readAsDataURL(file);
        }
    }

    // --- ACTUAL FILE UPLOAD / DOWNLOAD LOGIC FOR VERSIONS ---

    function triggerFileUpload(assignmentId) {
        state.uploadingAssignmentId = assignmentId;
        document.getElementById('global-file-upload').click();
    }

    function processFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const idx = state.assignments.findIndex(a => a.id === state.uploadingAssignmentId);
        if (idx > -1) {
            const assignment = state.assignments[idx];
            
            // Calculate Next Version Number (v01, v02, v03...)
            const nextVNum = assignment.versions.length + 1;
            const nextVName = nextVNum < 10 ? `v0${nextVNum}` : `v${nextVNum}`;
            
            // Create a local blob URL for actual downloading
            const fileUrl = URL.createObjectURL(file);
            
            // Add new version to the front
            assignment.versions.unshift({
                vName: nextVName,
                fileUrl: fileUrl,
                filename: file.name
            });
            
            assignment.status = 'uploaded';
            showToast(`File "${file.name}" uploaded successfully. Status: Published.`);
            
            document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
        }
        
        // Reset input so same file can be chosen again if needed
        e.target.value = '';
        state.uploadingAssignmentId = null;
    }

    function handleDownload(assignmentId, versionIndex) {
        const assignment = state.assignments.find(a => a.id === assignmentId);
        if (!assignment || !assignment.versions || assignment.versions.length === 0) {
            showToast('No files available to download for this assignment', true);
            return;
        }

        const version = assignment.versions[versionIndex];
        
        if (version.fileUrl) {
            // This is a real uploaded file - force browser download
            const a = document.createElement('a');
            a.href = version.fileUrl;
            a.download = version.filename || 'download';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast(`Downloading ${version.filename}...`);
        } else {
            // This is just placeholder mock data
            if (version.isRetake && !version.filename) {
                showToast(`No file attached to this retake note.`, true);
            } else {
                showToast(`Downloading placeholder: ${version.filename || version.vName}`);
            }
        }
    }

    function handleDownloadCompleted(assignmentId, levelIndex, e) {
        if(e) e.stopPropagation();
        const assignment = state.assignments.find(a => a.id === assignmentId);
        if (!assignment || !assignment.completedLevels || !assignment.completedLevels[levelIndex]) return;
        
        const levelData = assignment.completedLevels[levelIndex];
        
        if (levelData.finalFileUrl) {
            const a = document.createElement('a');
            a.href = levelData.finalFileUrl;
            a.download = levelData.finalFilename || 'download';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast(`Downloading final ${levelData.finalFilename}...`);
        } else {
            showToast(`Downloading placeholder: ${levelData.finalFilename || levelData.levelName}`);
        }
    }

    function handleDownloadStageVersion(assignmentId, levelIndex, versionIndex, e) {
        if(e) e.stopPropagation();
        const assignment = state.assignments.find(a => a.id === assignmentId);
        if (!assignment || !assignment.completedLevels || !assignment.completedLevels[levelIndex]) return;
        
        const version = assignment.completedLevels[levelIndex].versions[versionIndex];
        
        if (version.fileUrl) {
            const a = document.createElement('a');
            a.href = version.fileUrl;
            a.download = version.filename || 'download';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast(`Downloading ${version.filename}...`);
        } else {
            showToast(`Downloading placeholder: ${version.filename || version.vName}`);
        }
    }

    // --- RETAKE LOGIC ---
    function openRetakeModal(assignmentId) {
        state.uploadingAssignmentId = assignmentId;
        openModal('retake');
    }

    function handleRetakeFileUpload(e) {
        const file = e.target.files[0];
        if (file) {
            state.tempRetakeFileUrl = URL.createObjectURL(file);
            state.tempRetakeFileName = file.name;
            renderModals(); // re-render to show attached file name
        }
    }

    function submitRetake() {
        const note = document.getElementById('retake-note').value.trim();
        
        if (!note && !state.tempRetakeFileName) {
            showToast("Please provide either a note or attach a file.", true);
            return;
        }

        const idx = state.assignments.findIndex(a => a.id === state.uploadingAssignmentId);
        if (idx > -1) {
            const assignment = state.assignments[idx];
            
            const nextVNum = assignment.versions.length + 1;
            const nextVName = nextVNum < 10 ? `v0${nextVNum}` : `v${nextVNum}`;
            
            assignment.versions.unshift({
                vName: nextVName,
                fileUrl: state.tempRetakeFileUrl,
                filename: state.tempRetakeFileName,
                isRetake: true,
                note: note
            });
            
            assignment.status = 'retake';
            showToast(`Retake feedback sent successfully.`);
            closeModal();
            document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
        }
    }


    // --- PROFILE & OTHER UI LOGIC ---

    function toggleProfileMenu(e) {
        e.stopPropagation();
        state.profileMenuOpen = !state.profileMenuOpen;
        renderDashboard();
    }

    function triggerProfileUpload(e) {
        e.stopPropagation();
        document.getElementById('profile-upload-input').click();
        state.profileMenuOpen = false;
        renderDashboard();
    }

    function handleProfileUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                state.currentUser.profilePic = event.target.result;
                renderDashboard();
            };
            reader.readAsDataURL(file);
        }
    }

    function removeProfilePic(e) {
        e.stopPropagation();
        state.currentUser.profilePic = null;
        state.profileMenuOpen = false;
        renderDashboard();
    }

    function openEditNameModal(e) {
        e.stopPropagation();
        state.profileMenuOpen = false;
        openModal('edit-name');
    }

    function saveProfileName() {
        const newName = document.getElementById('edit-name-input').value.trim();
        if (!newName) {
            showToast("Name cannot be empty", true);
            return;
        }
        state.currentUser.name = newName;
        // Update user inside global array as well
        const userIndex = state.users.findIndex(u => u.id === state.currentUser.id);
        if (userIndex > -1) {
            state.users[userIndex].name = newName;
        }
        showToast("Name updated successfully!");
        closeModal();
        renderDashboard();
    }

    function setTab(tab) {
        state.activeTab = tab;
        renderLogin();
    }

    function handleLogin(type) {
        if (type === 'admin') {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const user = state.users.find(x => x.username === u && x.password === p);
            if (user) {
                state.currentUser = user;
                state.currentProject = state.projects.length > 0 ? state.projects[0].id : null;
                state.profileMenuOpen = false;
                renderDashboard();
                showToast("Logged in successfully");
            } else {
                showToast("Invalid Admin Credentials", true);
            }
        } else {
            const code = document.getElementById('logincode').value;
            const user = state.users.find(x => x.logincode === code);
            if (user) {
                state.currentUser = user;
                const allowed = user.allowedProjects || [];
                state.currentProject = allowed.length > 0 ? allowed[0] : null;
                state.profileMenuOpen = false;
                renderDashboard();
                showToast("Logged in successfully");
            } else {
                showToast("Invalid Login Code", true);
            }
        }
    }

    function logout() {
        state.currentUser = null;
        state.profileMenuOpen = false;
        renderLogin();
    }

    function setProject(id) {
        state.currentProject = id;
        state.searchQuery = '';
        renderDashboard();
    }

    function handleSearch(e) {
        state.searchQuery = e.target.value;
        document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
    }

    function toggleVersions(id) {
        if (state.expandedAssignments.includes(id)) {
            state.expandedAssignments = state.expandedAssignments.filter(x => x !== id);
        } else {
            state.expandedAssignments.push(id);
        }
        document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
    }

    function toggleStage(assignmentId, stageIndex) {
        const stageId = `${assignmentId}_${stageIndex}`;
        if (!state.expandedStages) state.expandedStages = [];
        
        if (state.expandedStages.includes(stageId)) {
            state.expandedStages = state.expandedStages.filter(id => id !== stageId);
        } else {
            state.expandedStages.push(stageId);
        }
        document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
    }

    function updateStatus(id, newStatus) {
        const idx = state.assignments.findIndex(a => a.id === id);
        if (idx > -1) {
            const a = state.assignments[idx];

            if (newStatus === 'approved') {
                const isLastLevel = (a.levels && a.levels.length > 0) ? (a.currentLevelIndex >= a.levels.length - 1) : true;
                
                // Process level completion if not already fully approved
                if (a.status !== 'approved') {
                    const latestVersion = a.versions.find(v => !v.isRetake) || a.versions[0];
                    if (!a.completedLevels) a.completedLevels = [];
                    
                    const levelNameStr = (a.levels && a.levels.length > 0) ? a.levels[a.currentLevelIndex] : 'Final';
                    
                    a.completedLevels.push({
                        levelName: levelNameStr,
                        finalFileUrl: latestVersion ? latestVersion.fileUrl : null,
                        finalFilename: latestVersion ? latestVersion.filename : 'Approved File',
                        finalVName: latestVersion ? latestVersion.vName : '',
                        versions: [...a.versions] // Save historical versions
                    });
                    
                    if (!isLastLevel) {
                        a.currentLevelIndex++;
                        a.status = 'paused';
                        a.versions = []; // Reset active versions for the next stage
                        showToast(`${levelNameStr} Approved! Moving to ${a.levels[a.currentLevelIndex]}`);
                    } else {
                        a.status = 'approved';
                        showToast(`Assignment fully approved!`);
                    }
                }
            } else {
                a.status = newStatus;
                let displayStatus = newStatus;
                if (newStatus === 'uploaded' || newStatus === 'client_approved') displayStatus = 'published';
                showToast(`Status changed to ${displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1)}`);
            }
            
            document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
        }
    }

    function openModal(type) {
        state.tempProjectImg = null;
        state.tempProjectName = '';
        state.tempAssignmentImg = null;
        state.tempAssignmentInputUrl = null;
        state.tempAssignmentInputName = null;
        state.tempAssignmentName = '';
        state.tempAssignmentMandays = '';
        state.tempAssignmentLevels = '';
        state.tempRetakeFileName = null;
        state.tempRetakeFileUrl = null;
        state.tempRetakeNote = '';
        
        const container = document.getElementById('modal-container');
        container.dataset.modalType = type;
        if(type === 'team') {
            state.generatedCode = '';
            state.selectedUserName = '';
            state.tempTeamUserName = '';
            state.tempTeamRole = 'client';
        }
        container.classList.remove('hidden');
        renderModals();
    }

    function closeModal() {
        const container = document.getElementById('modal-container');
        container.classList.add('hidden');
        container.innerHTML = '';
        state.tempProjectImg = null;
        state.tempProjectName = '';
        state.tempAssignmentImg = null;
        state.tempAssignmentInputUrl = null;
        state.tempAssignmentInputName = null;
        state.tempAssignmentName = '';
        state.tempAssignmentMandays = '';
        state.tempAssignmentLevels = '';
        state.tempRetakeFileName = null;
        state.tempRetakeFileUrl = null;
        state.tempRetakeNote = '';
        state.tempTeamUserName = '';
        state.tempTeamRole = 'client';
        state.pendingDeletion = null;
    }

    function createProject() {
        const name = document.getElementById('new-project-name').value;
        if (name.trim() === '') {
            showToast("Please enter a project name", true);
            return;
        }
        
        const newId = 'p' + (Date.now());
        const imgSrc = state.tempProjectImg || `https://placehold.co/100x100/333333/ffffff?text=${name.substring(0,3)}`;
        
        state.projects.push({
            id: newId,
            name: name,
            img: imgSrc,
            active: false
        });
        closeModal();
        setProject(newId);
        showToast("Project created successfully");
    }

    function createAssignment() {
        const name = document.getElementById('new-assignment-name').value;
        const mandaysInput = document.getElementById('new-assignment-mandays').value;
        const levelsInput = document.getElementById('new-assignment-levels').value.trim();
        
        if (name.trim() === '') {
            showToast("Please enter an assignment name", true);
            return;
        }
        
        // Parse Levels logic
        let parsedLevels = ['Level 1'];
        if (levelsInput) {
            if (/^\d+$/.test(levelsInput) && Number(levelsInput) > 0) {
                // Input is just a number (e.g. 3 -> Level 1, Level 2, Level 3)
                parsedLevels = Array.from({length: Number(levelsInput)}, (_, i) => `Level ${i+1}`);
            } else {
                // Input is custom names separated by commas
                parsedLevels = levelsInput.split(',').map(s => s.trim()).filter(s => s);
                if (parsedLevels.length === 0) parsedLevels = ['Level 1'];
            }
        }
        
        const mandays = mandaysInput ? parseFloat(mandaysInput) : 0;
        const imgSrc = state.tempAssignmentImg || `https://placehold.co/100x100/555555/ffffff?text=${name.substring(0,3)}`;

        state.assignments.unshift({
            id: 'a' + Date.now(),
            projectId: state.currentProject,
            name: name,
            status: 'paused', // New assignments start as paused
            img: imgSrc,
            mandays: mandays,
            levels: parsedLevels,
            currentLevelIndex: 0,
            completedLevels: [],
            inputData: {
                url: state.tempAssignmentInputUrl,
                name: state.tempAssignmentInputName
            },
            versions: [{vName: 'v01', fileUrl: null, filename: `${name.replace(/\s+/g, '_')}_v01.png`}],
            createdAt: Date.now() 
        });
        closeModal();
        document.getElementById('assignments-container').innerHTML = renderAssignmentsList();
        showToast("Assignment created (Paused)");
    }

    function generateCode() {
        const role = document.querySelector('input[name="role"]:checked').value;
        const name = document.getElementById('team-name').value;
        if (!name) { 
            showToast("Enter a name first.", true); 
            return; 
        }
        
        const r = () => Math.random().toString(36).substring(2, 6);
        state.generatedCode = `${r()}-${r()}-${r()}`;
        state.selectedUserName = name;
        
        state.users.push({
            id: 'u' + Date.now(),
            logincode: state.generatedCode,
            role: role,
            name: name,
            profilePic: null,
            allowedProjects: [] // Default to no project access, admin must assign
        });
        
        renderModals();
        if (state.currentUser) renderDashboard();
        
        showToast(`${name} added to the team!`);
    }

    // --- ROBUST CLIPBOARD LOGIC ---
    function copyTextToClipboard(text) {
        if (!text) return;

        const fallbackCopy = (textToCopy) => {
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            
            // Prevent scrolling and ensure it's "visible" enough to be focused
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "-9999px";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Access code copied to clipboard!');
                } else {
                    showToast('Failed to copy code', true);
                }
            } catch (err) {
                console.error('Fallback copy failed', err);
                showToast('Failed to copy code', true);
            }
            
            document.body.removeChild(textArea);
        };

        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text)
                .then(() => showToast('Access code copied to clipboard!'))
                .catch((err) => {
                    console.warn('Modern clipboard failed, using fallback.', err);
                    fallbackCopy(text);
                });
        } else {
            // Fallback for older browsers or insecure contexts (like iframes)
            fallbackCopy(text);
        }
    }

    function copyGeneratedCode() {
        copyTextToClipboard(state.generatedCode);
    }

    function copyUserCode(code) {
        copyTextToClipboard(code);
    }

    document.getElementById('modal-container').addEventListener('click', function(e) {
        if(e.target === this) {
            closeModal();
        }
    });

    renderLogin();

</script>
</body>
</html>